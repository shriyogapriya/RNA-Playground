<script>
    function showRecursion() {
        console.log("val:", $("#formula").val());
        setTimeout(function () {      //introduces a little delay, so that the thing will close slowly and neatly
            document.getElementById("recursion").innerHTML =  availableAlgorithms[$("#formula").val()].getRecursionInLatex();
            rerendermath();
            $(".animate1").empty();
        }, 450);
        rerendermath();
    };
</script>

<div class="row" id="introduction">
   <div class="colW600">
    pknotsRG is an algorithm by 
     <a href="https://doi.org/10.1093/nar/gkm258">Reeder&Giegerich.</a>
      It is a tool for  folding RNA secondary structures, including the class of simple recursive pseudoknots. Here, we extend the
     <a href="index.jsp?toolName=Nussinov">Nussinov</a> algorithm for
     such a pseduknot prediction.
     <br />
     <br />
     Helical stem called 'Canonical stem' which comprises only canonical Watson-Crick base pairs. A cannonical stem with outermost base pair (i ; j) consists of the
     base pairs (i + k; j - k), k >= 0 such that for all 0 <= k' <= k
     (i + k'; j - k') is a valid Watson Crick base pair. 
     A canonical pseudoknot consists of two crossing canonical stems.
     <br/>
     <br />
     The following are the recursions used for pseduknot prediction.
     <div style="padding-left:45px;">
        $C(i,j)=\max\begin{cases} D(i+1,j-1)+1 & \text{if} j-i > l \text{and} S_i, S_j \text{compl. base pair} \\ 0 & \text{otherwise} \end{cases}$,
        <br /> 
        <br />
        which is used to find the maximal length of canonical stem with outermost bp(i,j)
        <br />
        <br />
        $P(i,j) =\max\begin{cases} D(i,j-1) & S_j  \text{unpaired} \\max_{i < k< (j-l)} D(i,k-1)+D(k+1,j-1)+1 & \text{if} S_k,S_j \text{ compl. base pair} \\max_{i < k < l < j} D(i+1,j-1)+1 & \text{ encoded by c} \end{cases}$,
        <br /> 
        <br />
        which is used to find the maximum number of bps in range k...l
     </div>
     <br/>
     <br />
     Here, Since only two helices participate in one pseudoknot, we loop over all possible knots in one O(n4) loop and store the result in a two-dimensional matrix. 
     Finally, the traceback is visualized. 
   </div>

   <div class="colW150">
    <img alt="Canonical pseudoknot" src="pkcanonical.PNG" width=170 height=120 >
  </div>
</div>

<div id="inputContainer">

    <div class="row">
            <div class="colW250" style="font-size: 120%; vertical-align: bottom; ">RNA sequence:</div>
            <div class="colW400">
                <input id="rawSeq" data-bind="value: rawSeq" class="userInput"
                       placeholder="Example 'GCACGACG'" onkeydown="validate(event)"
                       style="text-transform:uppercase">
            </div>
    </div>

    <div class="row">
            <div class="colW250" style="font-size: 120%">Minimal loop length $l$:</div>
            <div class="colW400">
                <select data-bind="value: loopLength" id="ll" style="width:40px;">
                    <option value=0>0</option>
                    <option value=1>1</option>
                    <option value=2>2</option>
                    <option value=3>3</option>
                    <option value=4>4</option>
                    <option value=5>5</option>
                </select>
                <label for="ll" style="margin-left:10px;">i.e. minimal number of enclosed positions</label>
            </div>
    </div>

    <div class="row">
            <div class="colW250" style="font-size: 120%">Energy weight of base pair $E_{bp}$:</div>
            <div class="colW400">
                <input data-bind="value: input.energy" id="energy" type="range" max="2" min="-2" step="(max - min) / 100">
                <label for="energy" data-bind="text: input.energy"></label>
            </div>
    </div>

    <div class="row">
        <div class="colW250" style="font-size: 120%">Delta:</div>
            <div class="colW400">
                <select id="delta" data-bind="value: input.delta" style="width:40px;">
                    <option value=0>0</option>
                    <option value=1>1</option>
                    <option value=2>2</option>
                    <option value=3>3</option>
                    <option value=4>4</option>
                    <option value=5>5</option>
                </select>
                <label for="delta" style="margin-left:10px;">for suboptimal traceback</label>
            </div>
    </div>

    <div class="row">
        <div id="rec_select" style="display: none;">pkCanonical</div>
    </div>
</div>


<div id="output">
        <script type="text/javascript">
            showRecursion();
        </script>
    <div class="scroll_table">
        <table id="matrixC">
          <thead>
            <tr>
              <th class="cell_count" style="font-size: 16px; color: darkslategray">$C$</th>
              <th class="cell_count"></th>
              <!-- ko foreach: { data: seqList, as: 'base' } -->
              <th class="cell_count" data-bind="writeSeq: [base, $index()+1]"></th>
              <!-- /ko -->
            </tr>
          </thead>
    
          <tbody id="matrix_body" data-bind="foreach: { data: cells()[0], as: 'cell' }">
                <tr>
                    <th class="cell_mea_th" data-bind="writeSeq: [$root.seqList()[$index()], $index()+1]"></th>
                    <!-- ko foreach: { data: cell, as: 'v' } -->
                    <td class="cell_mea" data-bind="text: v.i < v.j+2 ? v.value : '', event: { mousedown: $root.clickCell.bind(this) }, attr: {title: 'i=' + v.i + ' j=' + v.j}"></td>
                    <!-- /ko -->
                </tr>
            </tbody>
        </table>
      </div>
    
    
    
    <div class="scroll_table">
      <table id="matrixp">
            <thead>
            <tr>
                <th class="cell_count" style="font-size: 16px; color: darkslategray">$P$</th>
                <th class="cell_count"></th>
            <!-- ko foreach: { data: seqList, as: 'base' } -->
                <th class="cell_count" data-bind="writeSeq: [base, $index()+1]"></th>
            <!-- /ko -->
            </tr>
            </thead>
    
            <tbody id="matrix_body" data-bind="foreach: { data: cells()[0], as: 'cell' }">
                <tr>
                    <th class="cell_mea_th" data-bind="writeSeq: [$root.seqList()[$index()], $index()+1]"></th>
                    <!-- ko foreach: { data: cell, as: 'v' } -->
                    <td class="cell_mea" data-bind="text: v.i < v.j+2 ? v.value : '', event: { mousedown: $root.clickCell.bind(this) }, attr: {title: 'i=' + v.i + ' j=' + v.j}"></td>
                    <!-- /ko -->
                </tr>
            </tbody>
      </table>
    </div>
    <div><a href="javascript:generate_tables()">Download Tables</a></div>
    <div class="col_structures">
            <table id="structures" style="margin:0;">
                <thead>
                <tr>
                    <th id="structTableHeading">Possible Structures</th>
                </tr>
                </thead>

                <tbody data-bind="foreach: { data: tracebacks, as: 'tb' }">
                <tr><td id="structTableCells" data-bind="text: tb.structure, event: {mousedown:$parent.clickStructure}"
                    onclick="fornaRendering( document.getElementById('rawSeq').value, this)"></td></tr>
                </tbody>
            </table>
        </div>
</div>
<script src="js/visualize.js"></script>
<!-- ensure structure list changes clear the forna rendering -->
<script type="text/javascript">/* <![CDATA[ */$("#structures").bind("DOMSubtreeModified", fornaClear);/* ]]> */</script>
